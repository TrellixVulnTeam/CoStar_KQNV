-file("test/lib/hipe/regalloc/hipe_amd64_specific_x87.erl", 1).

-file("test/lib/hipe/regalloc/hipe_x86_specific_x87.erl", 1).

-module(hipe_amd64_specific_x87).

-export([allocatable/0,
         is_precoloured/1,
         is_arg/1,
         new_spill_index/1,
         number_of_temporaries/1]).

-export([analyze/1,
         bb/2,
         args/1,
         labels/1,
         livein/2,
         liveout/2,
         uses/1,
         defines/1,
         is_global/1,
         reg_nr/1,
         physical_name/1,
         breadthorder/1,
         postorder/1,
         reverse_postorder/1]).

breadthorder(CFG) ->
    hipe_x86_cfg:breadthorder(CFG).

postorder(CFG) ->
    hipe_x86_cfg:postorder(CFG).

reverse_postorder(CFG) ->
    hipe_x86_cfg:reverse_postorder(CFG).

is_global(_) ->
    false.

is_arg(_) ->
    false.

args(_) ->
    [].

analyze(CFG) ->
    hipe_amd64_liveness:analyze(CFG).

livein(Liveness, L) ->
    [ 
     X ||
         X <- hipe_amd64_liveness:livein(Liveness, L),
         hipe_x86:temp_is_allocatable(X),
         hipe_x86:temp_type(X) =:= double
    ].

liveout(BB_in_out_liveness, Label) ->
    [ 
     X ||
         X <- hipe_amd64_liveness:liveout(BB_in_out_liveness, Label),
         hipe_x86:temp_is_allocatable(X),
         hipe_x86:temp_type(X) =:= double
    ].

allocatable() ->
    hipe_amd64_registers:allocatable_x87().

is_precoloured(Reg) ->
    hipe_amd64_registers:is_precoloured_x87(Reg).

physical_name(Reg) ->
    Reg.

labels(CFG) ->
    hipe_x86_cfg:labels(CFG).

number_of_temporaries(_CFG) ->
    Highest_temporary = hipe_gensym:get_var(x86),
    Highest_temporary + 1.

bb(CFG, L) ->
    hipe_x86_cfg:bb(CFG, L).

uses(I) ->
    [ 
     X ||
         X <- hipe_amd64_defuse:insn_use(I),
         hipe_x86:temp_is_allocatable(X),
         temp_is_double(X)
    ].

defines(I) ->
    [ 
     X ||
         X <- hipe_amd64_defuse:insn_def(I),
         hipe_x86:temp_is_allocatable(X),
         temp_is_double(X)
    ].

temp_is_double(Temp) ->
    hipe_x86:temp_type(Temp) =:= double.

reg_nr(Reg) ->
    hipe_x86:temp_reg(Reg).

new_spill_index(SpillIndex) ->
    SpillIndex + 1.

-file("test/lib/hipe/regalloc/hipe_amd64_specific_x87.erl", 21).



