-file("test/lib/diameter/src/base/diameter_session.erl", 1).

-module(diameter_session).

-export([sequence/0,sequence/1,session_id/1,origin_state_id/0]).

-export([init/0]).

-spec sequence() -> diameter:'Unsigned32'().

sequence() ->
    Instr = {_Pos = 2,_Incr = 1,_Threshold = 4294967295,_SetVal = 0},
    ets:update_counter(diameter_sequence, sequence, Instr).

-spec sequence(diameter:sequence()) -> diameter:'Unsigned32'().

sequence({_,32}) ->
    sequence();
sequence({H,N}) ->
    H bsl N bor sequence() band (1 bsl N - 1).

-spec origin_state_id() -> diameter:'Unsigned32'().

origin_state_id() ->
    ets:lookup_element(diameter_sequence, origin_state_id, 2).

-spec session_id(diameter:'DiameterIdentity'()) ->
                    diameter:'OctetString'().

session_id(Host) ->
    Instr =
        {_Pos = 2,_Incr = 1,_Threshold = 18446744073709551615,_Set = 0},
    N = ets:update_counter(diameter_sequence, session_base, Instr),
    Hi = N bsr 32,
    Lo = N band 4294967295,
    [Host,
     ";",
     integer_to_list(Hi),
     ";",
     integer_to_list(Lo),
     ";",
     atom_to_list(node())].

init() ->
    Now = now(),
    random:seed(Now),
    Time = time32(Now),
    Seq =
        4294967295 band (Time bsl 20) bor (random:uniform(1 bsl 20) - 1),
    ets:insert(diameter_sequence,
               [{origin_state_id,Time},
                {session_base,Time bsl 32},
                {sequence,Seq}]),
    Time.

time32(Now) ->
    Time = calendar:now_to_universal_time(Now),
    Diff = calendar:datetime_to_gregorian_seconds(Time) - 62105714048,
    Diff band 4294967295.



