-file("test/lib/hipe/amd64/hipe_amd64_liveness.erl", 1).

-file("test/lib/hipe/amd64/../x86/hipe_x86_liveness.erl", 1).

-module(hipe_x86_liveness).

-export([analyse/1]).

-export([liveout/2]).

-export([uses/1,defines/1]).

-file("test/lib/hipe/amd64/../x86/../x86/hipe_x86.hrl", 1).

-record(x86_temp,{reg,type,allocatable}).

-record(x86_imm,{value}).

-record(x86_mem,{base,off,type}).

-record(x86_fpreg,{reg,pseudo}).

-record(x86_mfa,{m :: undefined | atom(),
                 f :: undefined | atom(),
                 a :: undefined | arity()}).

-record(x86_prim,{prim}).

-record(x86_sdesc,{exnlab,
                   fsize,
                   arity :: undefined | arity(),
                   live :: undefined | tuple()}).

-record(alu,{aluop,src,dst}).

-record(call,{'fun',sdesc,linkage}).

-record(cmovcc,{cc,src,dst}).

-record(cmp,{src,dst}).

-record(comment,{term}).

-record(fmove,{src,dst}).

-record(fp_binop,{op,src,dst}).

-record(fp_unop,{op,arg}).

-record(imul,{imm_opt,src,temp}).

-record(jcc,{cc,label}).

-record(jmp_fun,{'fun',linkage}).

-record(jmp_label,{label}).

-record(jmp_switch,{temp,jtab,labels}).

-record(label,{label}).

-record(lea,{mem,temp}).

-record(move,{src,dst}).

-record(move64,{imm,dst}).

-record(movsx,{src,dst}).

-record(movzx,{src,dst}).

-record(pseudo_call,{'fun',sdesc,contlab,linkage}).

-record(pseudo_jcc,{cc,true_label,false_label,pred}).

-record(pseudo_spill,{args = []}).

-record(pseudo_tailcall,{'fun',arity,stkargs,linkage}).

-record(pseudo_tailcall_prepare,{}).

-record(push,{src}).

-record(pop,{dst}).

-record(ret,{npop}).

-record(shift,{shiftop,src,dst}).

-record(test,{src,dst}).

-file("test/lib/hipe/amd64/../x86/../x86/../misc/hipe_consttab.hrl", 1).

-type ct_alignment() :: 4 | 8.

-type hipe_constlbl() :: non_neg_integer().

-type hipe_consttab() :: {dict(), [hipe_constlbl()], hipe_constlbl()}.

-file("test/lib/hipe/amd64/../x86/../x86/hipe_x86.hrl", 111).

-file([], 111).

-record(defun,{mfa :: undefined | mfa(),
               formals,
               code,
               data :: undefined | hipe_consttab(),
               isclosure :: undefined | boolean(),
               isleaf :: undefined | boolean(),
               var_range,
               label_range}).

-file("test/lib/hipe/amd64/../x86/hipe_x86_liveness.erl", 38).

-file([], 38).

-file("test/lib/hipe/amd64/../x86/../flow/liveness.inc", 1).

-export([analyze/1,livein/2]).

-file("test/lib/hipe/amd64/../x86/../flow/../flow/cfg.hrl", 1).

-type cfg_lbl() :: non_neg_integer().

-record(cfg_info,{'fun' :: undefined | mfa(),
                  start_label :: undefined | cfg_lbl(),
                  is_closure :: undefined | boolean(),
                  closure_arity :: undefined | arity(),
                  is_leaf :: undefined | boolean(),
                  params,
                  info = []}).

-type cfg_data() :: {dict(), [cfg_lbl()], non_neg_integer()}.

-record(cfg,{table = gb_trees:empty() :: gb_tree(),
             info :: undefined | #cfg_info{},
             data :: undefined | cfg_data()}).

-type cfg() :: #cfg{}.

-file("test/lib/hipe/amd64/../x86/../flow/liveness.inc", 51).

-file([], 51).

-spec analyze(cfg()) -> gb_tree().

analyze(CFG) ->
    PO = cfg_postorder(CFG),
    InitLiveness = liveness_init(init(PO, CFG)),
    Res = merry_go_around(PO, InitLiveness, 0),
    Res.

merry_go_around(Labels, Liveness, Count) ->
    case doit_once(Labels, Liveness, 0) of
        {NewLiveness,0} ->
            NewLiveness;
        {NewLiveness,_Changed} ->
            merry_go_around(Labels, NewLiveness, Count + 1)
    end.

doit_once([], Liveness, Changed) ->
    {Liveness,Changed};
doit_once([L|Ls], Liveness, Changed) ->
    LiveOut = liveout(Liveness, L),
    Kill = ordsets:subtract(LiveOut, kill(L, Liveness)),
    LiveIn = ordsets:union(Kill, gen(L, Liveness)),
    {NewLiveness,ChangedP} = update_livein(L, LiveIn, Liveness),
    doit_once(Ls, NewLiveness, Changed + ChangedP).

update_livein(Label, NewLiveIn, Liveness) ->
    {GK,LiveIn,Successors} = liveness_lookup(Label, Liveness),
    NewLiveness =
        liveness_update(Label, {GK,NewLiveIn,Successors}, Liveness),
    if
        LiveIn =:= NewLiveIn ->
            {NewLiveness,0};
        true ->
            {NewLiveness,1}
    end.

liveout(Liveness, L) ->
    Succ = successors(L, Liveness),
    case Succ of
        [] ->
            liveout_no_succ();
        _ ->
            liveout1(Succ, Liveness)
    end.

liveout1(Labels, Liveness) ->
    liveout1(Labels, Liveness, ordsets:new()).

liveout1([], _Liveness, Live) ->
    Live;
liveout1([L|Ls], Liveness, Live) ->
    liveout1(Ls, Liveness, ordsets:union(livein(Liveness, L), Live)).

successors(L, Liveness) ->
    {_GK,_LiveIn,Successors} = liveness_lookup(L, Liveness),
    Successors.

-spec livein(gb_tree(), _) -> [_].

livein(Liveness, L) ->
    {_GK,LiveIn,_Successors} = liveness_lookup(L, Liveness),
    LiveIn.

kill(L, Liveness) ->
    {{_Gen,Kill},_LiveIn,_Successors} = liveness_lookup(L, Liveness),
    Kill.

gen(L, Liveness) ->
    {{Gen,_Kill},_LiveIn,_Successors} = liveness_lookup(L, Liveness),
    Gen.

init([], _) ->
    [];
init([L|Ls], CFG) ->
    BB = cfg_bb(CFG, L),
    Code = hipe_bb:code(BB),
    Succ = cfg_succ(CFG, L),
    Transfer = make_bb_transfer(Code, Succ),
    [{L,{Transfer,ordsets:new(),Succ}}|init(Ls, CFG)].

make_bb_transfer([], _Succ) ->
    {ordsets:new(),ordsets:new()};
make_bb_transfer([I|Is], Succ) ->
    {Gen,Kill} = make_bb_transfer(Is, Succ),
    InstrGen = ordsets:from_list(uses(I)),
    InstrKill = ordsets:from_list(defines(I)),
    Gen1 = ordsets:subtract(Gen, InstrKill),
    Gen2 = ordsets:union(Gen1, InstrGen),
    Kill1 = ordsets:union(Kill, InstrKill),
    Kill2 = ordsets:subtract(Kill1, InstrGen),
    {Gen2,Kill2}.

liveness_init(List) ->
    liveness_init(List, gb_trees:empty()).

liveness_init([{Lbl,Data}|Left], Acc) ->
    liveness_init(Left, gb_trees:insert(Lbl, Data, Acc));
liveness_init([], Acc) ->
    Acc.

liveness_lookup(Label, Liveness) ->
    gb_trees:get(Label, Liveness).

liveness_update(Label, Val, Liveness) ->
    gb_trees:update(Label, Val, Liveness).

-file("test/lib/hipe/amd64/../x86/hipe_x86_liveness.erl", 40).

-file([], 40).

analyse(CFG) ->
    analyze(CFG).

cfg_bb(CFG, L) ->
    hipe_x86_cfg:bb(CFG, L).

cfg_postorder(CFG) ->
    hipe_x86_cfg:postorder(CFG).

cfg_succ(CFG, L) ->
    hipe_x86_cfg:succ(CFG, L).

uses(Insn) ->
    hipe_x86_defuse:insn_use(Insn).

defines(Insn) ->
    hipe_x86_defuse:insn_def(Insn).

liveout_no_succ() ->
    ordsets:from_list(lists:map(fun({Reg,Type}) ->
                                       hipe_x86:mk_temp(Reg, Type)
                                end,
                                hipe_x86_registers:live_at_return())).

-file("test/lib/hipe/amd64/hipe_amd64_liveness.erl", 21).



